<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/*
    Author       : Mitchell Simoens
    Site         : http://simoens.org/
    Contact Info : mitchellsimoens@gmail.com
    Purpose      : Creation of a plugin to turn any ExtJS 4 element into a file droppable element

    License      : MIT (http://www.opensource.org/licenses/mit-license.php)
    Warranty     : none
    Price        : free
    Version      : 1.0
    Date         : 3/15/2011
*/

// Spec - http://www.w3.org/TR/FileAPI/

Ext.define(&quot;GXC.plugin.FileDrop&quot;, {
    extend: &quot;Ext.AbstractPlugin&quot;,
    alias: &quot;plugin.filedrop&quot;,

    readType: &quot;DataURL&quot;,

    init: function(cmp) {
        var me = this;

        cmp.addEvents({
            dragover: true,
            drop: true,
            beforeload: true,
            load: true,
            loadstart: true,
            loadend: true,
            loadabort: true,
            loaderror: true,
            progress: true
        });

        cmp.on(&quot;afterrender&quot;, me.initFileDrop, me);
    },

    initFileDrop: function(cmp) {
        var me = this,
            el = me.el || cmp.getEl();

        el.on(&quot;dragover&quot;, me.onDragOver, me);
        el.on(&quot;drop&quot;, me.onDrop, me);
    },

    onDragOver: function(e) {
        e.stopEvent();

        var cmp = this.cmp;
        cmp.fireEvent(&quot;dragover&quot;, cmp, e);
    },

    onDrop: function(e) {
        e.stopEvent();

        var cmp = this.cmp,
            browserEvent = e.browserEvent,
            dataTransfer = browserEvent.dataTransfer,
            files = dataTransfer.files,
            numFiles = files.length,
            i = 0,
            file;

        cmp.fireEvent(&quot;drop&quot;, cmp, e);

        for (; i &lt; numFiles; i++) {
            file = files[i];
            this.readFile(file);
        }
    },

    readFile: function(file) {
        var me = this,
            cmp = me.cmp,
            reader = new FileReader();

        if (!cmp.fireEvent(&quot;beforeread&quot;, cmp, file)) {
            return false;
        }

        reader.onload = Ext.bind(me.handleFileEvent, me, [file], true);
        reader.onprogress = Ext.bind(me.handleFileEvent, me, [file], true);
        reader.onloadstart = Ext.bind(me.handleFileEvent, me, [file], true);
        reader.onloadend = Ext.bind(me.handleFileEvent, me, [file], true);
        reader.onabort = Ext.bind(me.handleFileEvent, me, [file], true);
        reader.onerror = Ext.bind(me.handleFileEvent, me, [file], true);

        reader[&quot;readAs&quot; + me.readType](file);
    },

    handleFileEvent: function(e, file) {
        var cmp = this.cmp,
            type = e.type;

        if (type === &quot;load&quot;) {
            if (!cmp.fireEvent(&quot;before&quot; + e.type, cmp, e, file)) {
                return false;
            }
        } else if (type === &quot;abort&quot; || type === &quot;error&quot;) {
            type = &quot;load&quot; + type;
        }

        cmp.fireEvent(type, cmp, e, file);
    }
});
</pre>
</body>
</html>
