<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/*
This file is part of Ext JS 4.2

Copyright (c) 2011-2013 Sencha Inc

Contact:  http://www.sencha.com/contact

GNU General Public License Usage
This file may be used under the terms of the GNU General Public License version 3.0 as
published by the Free Software Foundation and appearing in the file LICENSE included in the
packaging of this file.

Please review the following information to ensure the GNU General Public License version 3.0
requirements will be met: http://www.gnu.org/copyleft/gpl.html.

If you are unsure which license is appropriate for your use, please contact the sales department
at http://www.sencha.com/contact.

Build date: 2013-05-16 14:36:50 (f9be68accb407158ba2b1be2c226a6ce1f649314)
*/
<span id='Ext-direct-PollingProvider'>/**
</span> * Provides for repetitive polling of the server at distinct {@link #interval intervals}.
 * The initial request for data originates from the client, and then is responded to by the
 * server.
 * 
 * Configuration for the PollingProvider can be generated by the server-side
 * API portion of the Ext.Direct stack.
 *
 * An instance of PollingProvider may be created directly via the new keyword or by simply
 * specifying `type = &#39;polling&#39;`. For example:
 *
 *      var pollA = new Ext.direct.PollingProvider({
 *          type:&#39;polling&#39;,
 *          url: &#39;php/pollA.php&#39;,
 *      });
 *      Ext.direct.Manager.addProvider(pollA);
 *      pollA.disconnect();
 *      
 *      Ext.direct.Manager.addProvider({
 *          type:&#39;polling&#39;,
 *          url: &#39;php/pollB.php&#39;,
 *          id: &#39;pollB-provider&#39;
 *      });
 *      var pollB = Ext.direct.Manager.getProvider(&#39;pollB-provider&#39;);
 *
 */
Ext.define(&#39;Ext.direct.PollingProvider&#39;, {
    extend: &#39;Ext.direct.JsonProvider&#39;,
    alias:  &#39;direct.pollingprovider&#39;,
    
    requires: [
        &#39;Ext.Ajax&#39;,
        &#39;Ext.util.DelayedTask&#39;
    ],
    
    uses: [
        &#39;Ext.direct.ExceptionEvent&#39;,
        &#39;Ext.direct.Manager&#39;
    ],
    
<span id='Ext-direct-PollingProvider-cfg-interval'>    /**
</span>     * @cfg {Number} [interval=3000]
     * How often to poll the server-side in milliseconds. Defaults to every 3 seconds.
     */
    interval: 3000,

<span id='Ext-direct-PollingProvider-cfg-baseParams'>    /**
</span>     * @cfg {Object} [baseParams]
     * An object containing properties which are to be sent as parameters on every polling request
     */
    
<span id='Ext-direct-PollingProvider-cfg-url'>    /**
</span>     * @cfg {String/Function} url
     * The url which the PollingProvider should contact with each request. This can also be
     * an imported Ext.Direct method which will accept the baseParams as its only argument.
     */

    constructor: function(config) {
        var me = this;
        
        me.callParent(arguments);
        
        me.addEvents(
<span id='Ext-direct-PollingProvider-event-beforepoll'>            /**
</span>             * @event beforepoll
             * @preventable
             * Fired immediately before a poll takes place.
             *
             * @param {Ext.direct.PollingProvider} this
             */
            &#39;beforepoll&#39;,
            
<span id='Ext-direct-PollingProvider-event-poll'>            /**
</span>             * @event poll
             * Fired immediately after a poll takes place.
             *
             * @param {Ext.direct.PollingProvider} this
             */
            &#39;poll&#39;
        );
    },

<span id='Ext-direct-PollingProvider-method-isConnected'>    /**
</span>     * @inheritdoc
     */
    isConnected: function() {
        return !!this.pollTask;
    },

<span id='Ext-direct-PollingProvider-method-connect'>    /**
</span>     * Connect to the server-side and begin the polling process. To handle each
     * response subscribe to the data event.
     */
    connect: function() {
        var me = this,
            url = me.url;
        
        if (url &amp;&amp; !me.pollTask) {
            me.pollTask = Ext.TaskManager.start({
                run: me.runPoll,
                interval: me.interval,
                scope: me
            });
            
            me.fireEvent(&#39;connect&#39;, me);
        }
        //&lt;debug&gt;
        else if (!url) {
            Ext.Error.raise(&#39;Error initializing PollingProvider, no url configured.&#39;);
        }
        //&lt;/debug&gt;
    },

<span id='Ext-direct-PollingProvider-method-disconnect'>    /**
</span>     * Disconnect from the server-side and stop the polling process. The disconnect
     * event will be fired on a successful disconnect.
     */
    disconnect: function() {
        var me = this;
        
        if (me.pollTask) {
            Ext.TaskManager.stop(me.pollTask);
            delete me.pollTask;
            me.fireEvent(&#39;disconnect&#39;, me);
        }
    },
    
<span id='Ext-direct-PollingProvider-method-runPoll'>    /**
</span>     * @private
     */
    runPoll: function() {
        var me = this,
            url = me.url;
        
        if (me.fireEvent(&#39;beforepoll&#39;, me) !== false) {
            if (Ext.isFunction(url)) {
                url(me.baseParams);
            }
            else {
                Ext.Ajax.request({
                    url: url,
                    callback: me.onData,
                    scope: me,
                    params: me.baseParams
                });
            }
            
            me.fireEvent(&#39;poll&#39;, me);
        }
    },

<span id='Ext-direct-PollingProvider-method-onData'>    /**
</span>     * @private
     */
    onData: function(opt, success, response) {
        var me = this, 
            i, len, events;
        
        if (success) {
            events = me.createEvents(response);
            
            for (i = 0, len = events.length; i &lt; len; ++i) {
                me.fireEvent(&#39;data&#39;, me, events[i]);
            }
        }
        else {
            events = new Ext.direct.ExceptionEvent({
                data: null,
                code: Ext.direct.Manager.exceptions.TRANSPORT,
                message: &#39;Unable to connect to the server.&#39;,
                xhr: response
            });
            
            me.fireEvent(&#39;data&#39;, me, events);
        }
    }
});</pre>
</body>
</html>
